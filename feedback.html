<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feedback — dMood Labs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #050505;
      --surface: #0a0a0a;
      --surface-2: #111;
      --border: #222222;
      --border-2: #2e2e2e;
      --text: #ffffff;
      --text-2: #9b9b9b;
      --text-3: #777777;
      --text-4: #555;
      --accent: #8eff01;
      --accent-bg: #121a04;
      --mono: 'JetBrains Mono', monospace;
      --sans: 'Space Grotesk', system-ui, sans-serif;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      -webkit-font-smoothing: antialiased;
    }

    ::-webkit-scrollbar {
      width: 5px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #222;
      border-radius: 3px;
    }

    .viewer {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* ─── Topbar ─── */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      height: 52px;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .logo-link {
      display: block;
      height: 28px;
      text-decoration: none;
      flex-shrink: 0;
    }

    .logo-link img {
      height: 28px;
      width: auto;
      display: block;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .logo-link:hover img {
      opacity: 1;
    }

    .topbar-center {
      display: flex;
      align-items: center;
      gap: 12px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .device-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 20px;
    }

    .badge-name {
      font-size: 11px;
      font-weight: 600;
      color: #ccc;
    }

    .badge-dims {
      font-size: 10px;
      font-family: var(--mono);
      color: var(--text-3);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-newtab {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 7px 18px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      font-family: var(--sans);
      letter-spacing: 0.01em;
      cursor: pointer;
      text-decoration: none;
      transition: opacity 0.15s;
    }

    .btn-newtab:hover {
      opacity: 0.85;
    }

    /* ─── Layout ─── */
    .feedback-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .feedback-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: auto;
      position: relative;
    }

    .frame-shell {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.04),
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 32px 80px rgba(0, 0, 0, 0.3);
      transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1),
        height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      animation: reveal 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    .frame-shell iframe {
      display: block;
      border: none;
      background: #fff;
      transform-origin: top left;
    }

    /* ─── Comment overlay + markers ─── */
    .comment-overlay {
      position: absolute;
      z-index: 20;
      pointer-events: none;
    }

    .comment-marker {
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(142, 255, 1, 0.12);
      border: 1.5px solid rgba(142, 255, 1, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      line-height: 1;
      opacity: 0.75;
      cursor: pointer;
      pointer-events: auto;
      transform: translate(-50%, -50%);
      transition: opacity 0.15s, transform 0.15s;
      z-index: 21;
    }

    .comment-marker svg {
      color: var(--accent);
      stroke: var(--accent);
    }

    .comment-marker.hidden {
      display: none;
    }

    .comment-marker:hover {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.2);
    }

    .comment-marker.highlight {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1.4);
      transition: transform 0.3s, opacity 0.3s;
    }

    .comment-marker .marker-tooltip {
      display: none;
      position: absolute;
      bottom: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 11px;
      color: var(--text-2);
      font-family: var(--sans);
      white-space: normal;
      max-width: 220px;
      line-height: 1.5;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      pointer-events: none;
      z-index: 30;
    }

    .comment-marker:hover .marker-tooltip {
      display: block;
    }

    /* ─── Feedback panel (sidebar) ─── */
    .feedback-panel {
      width: 300px;
      flex-shrink: 0;
      border-left: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .feedback-panel-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .feedback-count {
      font-size: 10px;
      font-family: var(--mono);
      color: var(--text-3);
      background: var(--surface-2);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .feedback-list {
      flex: 1;
      overflow-y: auto;
    }

    .feedback-group-title {
      padding: 10px 16px 6px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-3);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      gap: 6px;
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 1;
    }

    .feedback-item {
      padding: 10px 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.03);
      transition: background 0.1s;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .feedback-item:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .feedback-item-top {
      display: flex;
      align-items: start;
      gap: 8px;
      cursor: pointer;
    }

    .feedback-item-desc {
      font-size: 12px;
      color: var(--text-2);
      line-height: 1.5;
      flex: 1;
    }

    .feedback-item-meta {
      font-size: 10px;
      color: var(--text-3);
      font-family: var(--mono);
    }

    .feedback-item-actions {
      display: flex;
      gap: 4px;
      margin-top: 2px;
    }

    .feedback-item-btn {
      padding: 3px 10px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text-3);
      font-size: 10px;
      font-weight: 500;
      font-family: var(--sans);
      cursor: pointer;
      transition: all 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .feedback-item-btn:hover {
      border-color: var(--border-2);
      color: var(--text-2);
    }

    .feedback-item-btn svg {
      width: 11px;
      height: 11px;
      flex-shrink: 0;
    }

    .feedback-item.solved {
      opacity: 0.5;
    }

    .feedback-item.solved .feedback-item-desc {
      text-decoration: line-through;
      color: var(--text-3);
    }

    .feedback-empty {
      padding: 40px 16px;
      text-align: center;
      color: var(--text-3);
      font-size: 12px;
      line-height: 1.6;
    }

    /* ─── Error state ─── */
    .error-overlay {
      position: absolute;
      inset: 0;
      z-index: 10;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      gap: 16px;
      text-align: center;
    }

    .error-overlay.visible {
      display: flex;
    }

    .error-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-2);
    }

    .error-desc {
      font-size: 12px;
      color: var(--text-3);
      max-width: 320px;
      line-height: 1.6;
    }

    /* ─── Footer ─── */
    .footer {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 24px;
      height: 36px;
      flex-shrink: 0;
      border-top: 1px solid var(--border);
      background: var(--surface);
    }

    .footer-text {
      font-size: 10px;
      color: var(--text-4);
      letter-spacing: 0.04em;
    }

    .footer-text a {
      color: var(--text-3);
      text-decoration: none;
    }

    .footer-text a:hover {
      color: var(--text-2);
    }

    @keyframes reveal {
      from {
        opacity: 0;
        transform: scale(0.97);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @media (max-width: 900px) {
      .topbar-center {
        position: static;
        transform: none;
      }
    }

    @media (max-width: 700px) {
      .feedback-panel {
        display: none;
      }
    }

    @media (max-width: 600px) {
      .topbar {
        padding: 0 12px;
        height: 48px;
        gap: 6px;
      }

      .topbar-center {
        position: static;
        transform: none;
        flex: 1;
        min-width: 0;
        justify-content: center;
      }

      .btn-newtab span {
        display: none;
      }

      .footer {
        height: 32px;
        padding: 8px 12px;
      }
    }
  </style>
</head>

<body>
  <div class="viewer">
    <div class="topbar">
      <a class="logo-link" href="/" title="dMood Labs">
        <img src="assets/logo.svg" alt="Logo">
      </a>

      <div class="topbar-center">
        <div class="device-badge">
          <span class="badge-name" id="badgeName">--</span>
          <span class="badge-dims" id="badgeDims">-- x --</span>
        </div>
      </div>

      <div class="topbar-right">
        <a class="btn-newtab" id="openBtn" href="#" target="_blank" rel="noopener noreferrer">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
          </svg>
          <span>Open in new tab</span>
        </a>
      </div>
    </div>

    <div class="feedback-layout">
      <div class="feedback-main" id="canvas">
        <div class="frame-shell" id="frameShell"></div>
        <div class="comment-overlay" id="commentOverlay"></div>

        <div class="error-overlay" id="errorOverlay">
          <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="1.2"
            stroke-linecap="round">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 8v4" />
            <path d="M12 16h.01" />
          </svg>
          <p class="error-title">Unable to load preview</p>
          <p class="error-desc">This site may not allow embedding. You can open it directly instead.</p>
          <a class="btn-newtab" id="errorOpenBtn" href="#" target="_blank" rel="noopener noreferrer"
            style="margin-top:8px">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
              <polyline points="15 3 21 3 21 9" />
              <line x1="10" y1="14" x2="21" y2="3" />
            </svg>
            <span>Open in new tab</span>
          </a>
        </div>
      </div>

      <div class="feedback-panel">
        <div class="feedback-panel-header">
          <span>Feedback</span>
          <span class="feedback-count" id="feedbackCount">0</span>
        </div>
        <div class="feedback-list" id="feedbackList">
          <div class="feedback-empty">No feedback yet. Comments added by reviewers will appear here in real time.</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <span class="footer-text">Powered by <a href="/">dMood Labs</a></span>
    </div>
  </div>

  <script>
    (function () {
      // ─── Parse params ───
      var params = new URLSearchParams(window.location.search);
      var url = params.get('url');
      var currentW = parseInt(params.get('w')) || 390;
      var currentH = parseInt(params.get('h')) || 844;
      var deviceName = params.get('device') || 'Preview';

      if (!url) {
        document.getElementById('errorOverlay').classList.add('visible');
        document.querySelector('.error-title').textContent = 'No URL provided';
        document.querySelector('.error-desc').textContent = 'This feedback link is missing a URL parameter.';
        return;
      }

      // ─── DOM refs ───
      var canvas = document.getElementById('canvas');
      var shell = document.getElementById('frameShell');
      var overlay = document.getElementById('errorOverlay');
      var commentOverlay = document.getElementById('commentOverlay');

      document.getElementById('openBtn').href = url;
      document.getElementById('errorOpenBtn').href = url;
      document.getElementById('badgeName').textContent = deviceName;
      document.getElementById('badgeDims').textContent = currentW + ' \u00d7 ' + currentH;
      document.title = deviceName + ' Feedback \u2014 dMood Labs';

      // ─── Firebase init ───
      // TODO: Replace with your Firebase project config (same as view.html)
      var firebaseConfig = {
        apiKey: "AIzaSyAosC2l0YvIoSHoX2iIiQNRNGl-2uk1I_4",
        authDomain: "dmood-deviceview.firebaseapp.com",
        databaseURL: "https://dmood-deviceview-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "dmood-deviceview",
        storageBucket: "dmood-deviceview.firebasestorage.app",
        messagingSenderId: "528636137555",
        appId: "1:528636137555:web:b798aefbab8ca8456ef6a6",
        measurementId: "G-XRT5L1LLXH"
      };

      var firebaseReady = false;
      var commentsRef = null;
      try {
        if (typeof firebase !== 'undefined' && firebase.initializeApp) {
          firebase.initializeApp(firebaseConfig);
          var db = firebase.database();
          var shareId = (function () {
            var raw = (url || '') + '|' + currentW + '|' + currentH;
            return btoa(raw).replace(/[^a-zA-Z0-9]/g, '').substring(0, 40);
          })();
          commentsRef = db.ref('comments/' + shareId);
          firebaseReady = true;
        }
      } catch (e) {
        console.warn('Firebase init failed:', e);
      }

      // ─── Categories ───
      var CATEGORIES = {
        color: {
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>',
          label: 'Color'
        },
        text: {
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>',
          label: 'Text'
        },
        layout: {
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
          label: 'Layout'
        },
        content: {
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
          label: 'Content'
        },
        bug: {
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 2 1.88 1.88M14.12 3.88 16 2M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5M6 13H2M3 21c0-2.1 1.7-3.9 3.8-4M20.97 5c0 2.1-1.6 3.8-3.5 4M22 13h-4M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>',
          label: 'Bug'
        },
        other: {
          icon: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
          label: 'Other'
        }
      };

      var comments = {};
      var hiddenComments = JSON.parse(localStorage.getItem('dv_hidden_' + url) || '{}');

      // ─── SPA page tracking ───
      var currentPageId = 'page-default';
      var isCrossOrigin = false;

      function getPageId() {
        try {
          var iframe = shell.querySelector('iframe');
          if (!iframe || !iframe.contentWindow) return 'page-default';

          var iframeDoc = iframe.contentWindow.document;
          var iframeUrl = iframe.contentWindow.location.href;
          var iframeTitle = iframeDoc.title || '';

          // Same-origin: use URL + title
          isCrossOrigin = false;
          var pageKey = iframeUrl + '|' + iframeTitle;
          var hash = 0;
          for (var i = 0; i < pageKey.length; i++) {
            var chr = pageKey.charCodeAt(i);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0;
          }
          return 'page-' + Math.abs(hash).toString(36);
        } catch (e) {
          // Cross-origin: use visual fingerprint
          isCrossOrigin = true;
          return getVisualPageId();
        }
      }

      function getVisualPageId() {
        try {
          var iframe = shell.querySelector('iframe');
          if (!iframe || !iframe.contentWindow || !iframe.contentWindow.document) {
            return 'page-default';
          }

          var doc = iframe.contentWindow.document;
          var fingerprint = [];

          // Collect visible headings text
          var headings = doc.querySelectorAll('h1, h2, h3');
          for (var i = 0; i < Math.min(headings.length, 5); i++) {
            var text = (headings[i].textContent || '').trim().substring(0, 50);
            if (text) fingerprint.push(text);
          }

          // Collect first paragraph
          var firstP = doc.querySelector('p');
          if (firstP) {
            var pText = (firstP.textContent || '').trim().substring(0, 30);
            if (pText) fingerprint.push(pText);
          }

          // Collect navigation items
          var navLinks = doc.querySelectorAll('nav a, [role="navigation"] a');
          var navTexts = [];
          for (var j = 0; j < Math.min(navLinks.length, 3); j++) {
            var linkText = (navLinks[j].textContent || '').trim().substring(0, 20);
            if (linkText) navTexts.push(linkText);
          }
          if (navTexts.length > 0) fingerprint.push(navTexts.join('|'));

          // Create hash from fingerprint
          if (fingerprint.length === 0) return 'page-default';

          var pageKey = fingerprint.join('||');
          var hash = 0;
          for (var k = 0; k < pageKey.length; k++) {
            var chr = pageKey.charCodeAt(k);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0;
          }

          var pageId = 'page-visual-' + Math.abs(hash).toString(36);
          console.log('Visual fingerprint:', fingerprint, '→', pageId);
          return pageId;
        } catch (e) {
          console.warn('Visual fingerprint failed:', e);
          return 'page-default';
        }
      }

      function updatePageId() {
        var newPageId = getPageId();
        if (newPageId !== currentPageId) {
          currentPageId = newPageId;
          renderMarkers();
          renderFeedbackList();
        }
      }

      // Monitor iframe for page changes
      var pageCheckInterval = setInterval(function() {
        updatePageId();
      }, 500);

      // ─── Render ───
      function calcAutoScale() {
        var rect = canvas.getBoundingClientRect();
        var s = Math.min((rect.width - 60) / currentW, (rect.height - 60) / currentH, 1);
        return Math.max(s, 0.1);
      }

      var currentScale = 0.5;

      function render() {
        currentScale = calcAutoScale();
        shell.style.width = (currentW * currentScale) + 'px';
        shell.style.height = (currentH * currentScale) + 'px';

        var iframe = shell.querySelector('iframe');
        if (iframe) {
          iframe.style.width = currentW + 'px';
          iframe.style.height = currentH + 'px';
          iframe.style.transform = 'scale(' + currentScale + ')';
        }

        positionOverlay();
        renderMarkers();
      }

      // ─── Overlay positioning ───
      function positionOverlay() {
        if (!commentOverlay) return;
        var shellRect = shell.getBoundingClientRect();
        var canvasRect = canvas.getBoundingClientRect();
        commentOverlay.style.left = (shellRect.left - canvasRect.left) + 'px';
        commentOverlay.style.top = (shellRect.top - canvasRect.top) + 'px';
        commentOverlay.style.width = shellRect.width + 'px';
        commentOverlay.style.height = shellRect.height + 'px';
      }

      // ─── Create iframe ───
      var iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.title = 'Preview';
      iframe.setAttribute('referrerpolicy', 'no-referrer');
      iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
      iframe.style.background = '#fff';
      iframe.style.display = 'block';
      iframe.style.border = 'none';
      iframe.style.transformOrigin = 'top left';
      iframe.style.width = currentW + 'px';
      iframe.style.height = currentH + 'px';

      var loadTimer = setTimeout(function () {
        overlay.classList.add('visible');
      }, 10000);

      iframe.onload = function () {
        clearTimeout(loadTimer);
        // Initialize page ID after iframe loads
        setTimeout(function() {
          currentPageId = getPageId();
          renderMarkers();
          renderFeedbackList();
        }, 300);
      };
      iframe.onerror = function () { clearTimeout(loadTimer); overlay.classList.add('visible'); };

      shell.appendChild(iframe);
      render();

      // ─── Resize ───
      var rt;
      window.addEventListener('resize', function () {
        clearTimeout(rt);
        rt = setTimeout(render, 80);
      });

      // ─── Markers ───
      function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function renderMarkers() {
        if (!commentOverlay) return;
        var old = commentOverlay.querySelectorAll('.comment-marker');
        for (var i = 0; i < old.length; i++) old[i].remove();

        var keys = Object.keys(comments);
        for (var k = 0; k < keys.length; k++) {
          var id = keys[k];
          var c = comments[id];
          if (!c) continue;

          // Filter by current page - only show comments for the current SPA page
          var commentPageId = c.pageId || 'page-default';
          if (commentPageId !== currentPageId) continue;

          // Skip hidden comments - they won't show as markers
          if (hiddenComments[id]) continue;

          var cat = CATEGORIES[c.category] || CATEGORIES.other;

          var leftPx = (c.x / 100) * currentW * currentScale;
          var topPx = (c.y / 100) * currentH * currentScale;

          var marker = document.createElement('div');
          marker.className = 'comment-marker';
          marker.dataset.id = id;
          marker.style.left = leftPx + 'px';
          marker.style.top = topPx + 'px';
          marker.innerHTML = '<span>' + cat.icon + '</span>' +
            '<div class="marker-tooltip"><strong>' + cat.label + '</strong><br>' + escapeHtml(c.description) +
            '<br><span style="opacity:0.5;font-size:10px">' + escapeHtml(c.author || '') + '</span></div>';

          commentOverlay.appendChild(marker);
        }
      }

      // ─── Feedback list ───
      var CAT_ORDER = ['bug', 'layout', 'color', 'text', 'content', 'other'];

      function renderFeedbackList() {
        var list = document.getElementById('feedbackList');
        var count = document.getElementById('feedbackCount');
        var keys = Object.keys(comments);
        var visibleCount = keys.filter(function(k) { return !hiddenComments[k]; }).length;
        count.textContent = visibleCount;

        if (keys.length === 0) {
          list.innerHTML = '<div class="feedback-empty">No feedback yet. Comments added by reviewers will appear here in real time.</div>';
          return;
        }

        // Separate active and hidden comments
        var activeItems = [];
        var hiddenItems = [];

        for (var i = 0; i < keys.length; i++) {
          var c = comments[keys[i]];
          var item = { id: keys[i], data: c };
          if (hiddenComments[keys[i]]) {
            hiddenItems.push(item);
          } else {
            activeItems.push(item);
          }
        }

        var html = '';

        // Render active comments grouped by category (only for current page)
        var pageActiveItems = activeItems.filter(function(item) {
          var commentPageId = item.data.pageId || 'page-default';
          return commentPageId === currentPageId;
        });

        if (pageActiveItems.length > 0) {
          var groups = {};
          for (var i = 0; i < pageActiveItems.length; i++) {
            var c = pageActiveItems[i].data;
            var catKey = c.category || 'other';
            if (!groups[catKey]) groups[catKey] = [];
            groups[catKey].push(pageActiveItems[i]);
          }

          for (var j = 0; j < CAT_ORDER.length; j++) {
            var gk = CAT_ORDER[j];
            if (!groups[gk]) continue;
            var cat = CATEGORIES[gk];
            groups[gk].sort(function (a, b) { return (b.data.createdAt || 0) - (a.data.createdAt || 0); });

            html += '<div class="feedback-group-title">' + cat.icon + ' ' + cat.label + ' (' + groups[gk].length + ')</div>';
            for (var k = 0; k < groups[gk].length; k++) {
              html += renderFeedbackItem(groups[gk][k], false);
            }
          }
        } else {
          html += '<div class="feedback-empty">All comments are marked as solved.</div>';
        }

        // Render solved/hidden comments (only for current page)
        var pageHiddenItems = hiddenItems.filter(function(item) {
          var commentPageId = item.data.pageId || 'page-default';
          return commentPageId === currentPageId;
        });

        if (pageHiddenItems.length > 0) {
          html += '<div class="feedback-group-title">';
          html += '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
          html += ' Solved (' + pageHiddenItems.length + ')</div>';
          pageHiddenItems.sort(function (a, b) { return (b.data.createdAt || 0) - (a.data.createdAt || 0); });
          for (var h = 0; h < pageHiddenItems.length; h++) {
            html += renderFeedbackItem(pageHiddenItems[h], true);
          }
        }

        list.innerHTML = html;
      }

      function renderFeedbackItem(item, isSolved) {
        var date = new Date(item.data.createdAt || 0);
        var timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        var html = '<div class="feedback-item' + (isSolved ? ' solved' : '') + '" data-id="' + item.id + '">';
        html += '<div class="feedback-item-top">';
        html += '<div class="feedback-item-desc">' + escapeHtml(item.data.description) + '</div>';
        html += '</div>';
        html += '<div class="feedback-item-meta">' + escapeHtml(item.data.author || '') + ' \u00b7 ' + timeStr + '</div>';
        html += '<div class="feedback-item-actions">';
        if (isSolved) {
          html += '<button class="feedback-item-btn" onclick="unhideComment(\'' + item.id + '\')">';
          html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>';
          html += 'Restore</button>';
        } else {
          html += '<button class="feedback-item-btn" onclick="highlightComment(\'' + item.id + '\')">';
          html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
          html += 'Locate</button>';
          html += '<button class="feedback-item-btn" onclick="hideComment(\'' + item.id + '\')">';
          html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
          html += 'Mark solved</button>';
        }
        html += '</div>';
        html += '</div>';
        return html;
      }

      // Functions to manage comment visibility
      window.hideComment = function (id) {
        hiddenComments[id] = true;
        localStorage.setItem('dv_hidden_' + url, JSON.stringify(hiddenComments));
        renderMarkers();
        renderFeedbackList();
      };

      window.unhideComment = function (id) {
        delete hiddenComments[id];
        localStorage.setItem('dv_hidden_' + url, JSON.stringify(hiddenComments));
        renderMarkers();
        renderFeedbackList();
      };

      window.highlightComment = function (id) {
        var marker = commentOverlay.querySelector('.comment-marker[data-id="' + id + '"]');
        if (!marker) return;

        // Remove previous highlights
        var all = commentOverlay.querySelectorAll('.comment-marker.highlight');
        for (var i = 0; i < all.length; i++) all[i].classList.remove('highlight');

        marker.classList.add('highlight');

        // Scroll marker into view if needed
        marker.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

        setTimeout(function () { marker.classList.remove('highlight'); }, 1500);
      };

      // ─── Firebase listener ───
      if (firebaseReady && commentsRef) {
        commentsRef.on('value', function (snapshot) {
          comments = snapshot.val() || {};
          renderMarkers();
          renderFeedbackList();
        });
      }
    })();
  </script>
</body>

</html>